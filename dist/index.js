const t={select:"get",insert:"post",update:"put",delete:"delete"},e=/,/gi;function r(t){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},r(t)}function n(t){var e=function(t,e){if("object"!=r(t)||!t)return t;var n=t[Symbol.toPrimitive];if(void 0!==n){var o=n.call(t,e);if("object"!=r(o))return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==r(e)?e:e+""}function o(t,e,r){return(e=n(e))in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t}let i,s;function u(t){i=t}const c={get apiUrl(){return i.apiUrl},get options(){return i.options||{}},getNestedRoute(t,e){var r;if(null!==(r=i)&&void 0!==r&&r.pathMap){const r=i.pathMap[t];return r?function(t,e){if(!e)throw new Error("You cannot query a nested route without a conditional clause (e.g., WHERE clause)");const r=function(t){const e=t.match(l)||[t];return e.map(t=>t.replace(a,""))}(t);return r.reduce((t,r)=>t.replace(`{${r}}`,e[r]),t)}(r,e):r}},dataExtractor:t=>i.dataExtractor?i.dataExtractor(t):t,refresh(t){i.refresh(t).then(t=>{i.options.headers=t})},hasRefresh:()=>i.hasOwnProperty("refresh"),getPolicy(t){var e;return t&&null!==(e=i[t])&&void 0!==e&&e.policy?i[t].policy:i.policy},hasPolicy(t){const e="policy";return i[t]&&i[t].hasOwnProperty(e)||i.hasOwnProperty(e)},hasCancel:()=>i.canCancel,set cancel(t){i.cancelController=t},hasDebug:()=>Boolean(i.debug),hasNodeProvider:()=>i.hasOwnProperty("nodeProvider"),getNodeProvider:()=>i.nodeProvider,hasAddons:()=>i.hasOwnProperty("addons"),getAddons:()=>(s||(s=i.addons.map(t=>(t.queryParser=t.queryParser.bind(t),t.resultSetFilter=t.resultSetFilter.bind(t),t))),s||[]),get path(){return i.path||{url:"",config:{}}}};const l=/{(.*?)}/g,a=/[{}]/g;function f(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),r.push.apply(r,n)}return r}function p(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{};e%2?f(Object(r),!0).forEach(function(e){o(t,e,r[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):f(Object(r)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))})}return t}const d="object"==typeof process&&"object"==typeof process.versions&&void 0!==process.versions.node,y={get:(t,e)=>h(t,"GET",e),put:(t,e)=>h(t,"PUT",e),post:(t,e)=>h(t,"POST",e),delete:t=>h(t,"DELETE")};function h(t,e,r){const n=r&&"GET"===e,o=c.path.hasOwnProperty(t),i=function(t){return t&&t.length>1&&t.endsWith("/")?t.slice(0,-1):t}(o&&o.url||c.apiUrl),s=o&&o.options||c.options,u=p(p({method:e,url:`${i}/${t}${n?`?${l=r,Object.keys(l).map(function(t){return encodeURIComponent(t)+"="+encodeURIComponent(l[t])}).join("&")}`:""}`,json:!0},n?{}:{body:r}),s);var l;const a=d&&c.hasNodeProvider()?c.getNodeProvider():m;return c.hasPolicy(t)?c.getPolicy(t).execute(()=>a(u,0,c,t)):a(u,0,c,t)}async function m(t,e=0,r,n){let o,i;c.hasCancel()&&(o=new AbortController,i=o.signal,c.cancel=o);const s=p(p(p({method:t.method},i?{signal:i}:{}),t.body?{body:JSON.stringify(t.body)}:{}),t.headers?{headers:t.headers}:{});if(c.hasDebug()){const e=p({},s);e.signal&&(e.signal="[AbortSignal]"),console.log("[querty][debug] api request:",{url:t.url,options:e})}const u=await fetch(t.url,s);if(function(t,e){return 401===t&&0===e&&c.hasRefresh()}(u.status,e)){const e=await async function(t,e){await c.refresh(e);const r=c.path.hasOwnProperty(e),n=r&&r.options||c.options;return p(p({},t),{},{headers:n.headers})}(t,n);return m(e,1)}{const t=await u.json();return{status:u.status,data:c.dataExtractor(t)}}}function b(t){return t.trim()}function g(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),r.push.apply(r,n)}return r}function v(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{};e%2?g(Object(r),!0).forEach(function(e){o(t,e,r[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):g(Object(r)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))})}return t}const O=/[()']/g,j=/\bJOIN\b|\bLEFT\s+JOIN\b|\bFULL\s+JOIN\b/gi,w=/\bJOIN\b|\bLEFT\s+JOIN\b|\bFULL\s+JOIN\b|\bON\b/i;function P(t){const{fieldsStr:e,fromSegment:r,whereSegment:n,groupByStr:o,havingStr:i,orderByStr:s}=function(t){const e=new RegExp([/^\s*SELECT\s+([\s\S]*?)/,/\s+FROM\s+([\s\S]*?)/,/(?:\s+WHERE\s+([\s\S]*?))?/,/(?:\s+GROUP\s+BY\s+([\s\S]*?))?/,/(?:\s+HAVING\s+([\s\S]*?))?/,/(?:\s+ORDER\s+BY\s+([\s\S]*?))?\s*$/].map(t=>t.source).join(""),"i"),r=t.match(e);if(!r)throw new Error("Invalid or unsupported SELECT query format");const n=(r[1]||"").trim(),o=(r[2]||"").trim(),i=r[3]?r[3].trim():void 0,s=r[4]?r[4].trim():void 0,u=r[5]?r[5].trim():void 0,c=r[6]?r[6].trim():void 0;return{fieldsStr:n,fromSegment:o,whereSegment:i,groupByStr:s,havingStr:u,orderByStr:c}}(t),u=function(t){return E(t)}(e),c=function(t){return t?E(t):void 0}(o),l=function(t){if(!t)return;const e=t.split(",").map(t=>t.trim()).filter(Boolean);return e.map(t=>{var e;const r=t.split(/\s+/).filter(Boolean),n=null===(e=r[r.length-1])||void 0===e?void 0:e.toUpperCase();let o="ASC";"ASC"!==n&&"DESC"!==n||(r.pop(),o=n);return{field:r.join(" ").trim(),direction:o}})}(s),{joinMatch:a,tables:f,joinCond:p,join:d}=function(t){const e=t.match(j);if(e){const[r,...n]=t.split(w),{joinTables:o,clauses:i}=n.reduce((t,e,r)=>(t[r%2==0?"joinTables":"clauses"].push(e.trim()),t),{joinTables:[r.trim()],clauses:[]});return{joinMatch:e,tables:o.map(b),joinCond:function(t){const e=[];for(let r=0;r<t.length;r++){const n=t[r],[o,i]=n.split("="),[,s]=o.split(".").map(b),[,u]=i.split(".").map(b);e.push([s,u])}return e}(i),join:e}}return{joinMatch:null,tables:t,joinCond:void 0,join:void 0}}(r),y=function(t){let e,r;if(t&&t.length>0){const n=t.match(/^(.*?)\s+IN\s*\(([\s\S]*?)\)\s*$/i);if(n){return{field:n[1].trim(),operator:"IN",values:N(`(${n[2].trim()})`)}}const o=t.indexOf("=");-1!==o&&(e=t.slice(0,o).trim(),r=t.slice(o+1).trim())}return{field:e,value:r}}(n),h=(()=>{if(!(n||a||c||i||l))return;const t={};return"IN"===(null==y?void 0:y.operator)?(t.operator="IN",t.values=y.values,y.field&&(t[y.field]=y.values)):null!=y&&y.field&&(t.value=y.value,t[y.field]=y.value),v(v({},t),{},{join:d,joinCond:p,groupBy:c,having:null==i?void 0:i.trim(),orderBy:l})})();return v({entities:a?f:E(f),fields:u},h?{conditions:h}:{})}function E(t){return t.split(",").map(b)}function S(t){const e=t.split(/INSERT INTO \b(\w+)\b|\bVALUES\b/i),r=e[2].replace(O,"").split(",").map(b);const n=N(e[4]);return{entity:e[1],data:r.reduce((t,e,r)=>(t[e]=n[r],t),{})}}function A(t){const e=new RegExp([/^s*UPDATEs+(\w+)/,/s+SETs+(.*?)/,/s+WHEREs+(.*)$/].map(t=>t.source.replace(/s/g,"\\s")).join(""),"i"),r=t.match(e);if(!r)throw new Error("Invalid or unsupported UPDATE query format");const n=r[1],o=r[2],i=r[3],s=function(t,e){return Object.fromEntries([...t.matchAll(e)].map(([,t,e,r])=>{const n=void 0!==e?e:r,o=n&&!isNaN(n)&&""!==n.trim()?Number(n):n;return[t.trim(),o]}))}(o,/(\w+)\s*=\s*(?:'([^']*)'|(\S+?))(?:,|$)/g),u=i.split("=")[1].trim();return{entity:n.trim(),data:s,id:u}}function N(t){return t.trim().slice(1,-1).split(",").map(t=>{const e=t.trim();if(e.startsWith("'")&&e.endsWith("'"))return e.slice(1,-1);if(!isNaN(e)&&""!==e.trim())return Number(e);return"null"===e.toLowerCase()?null:e})}function C(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var D,T,I,R,L,$;function B(){if(T)return D;T=1,D=function(i){return t.test(i)?i.toLowerCase():e.test(i)?(function(t){return t.replace(n,function(t,e){return e?" "+e:""})}(i)||i).toLowerCase():r.test(i)?function(t){return t.replace(o,function(t,e,r){return e+" "+r.toLowerCase().split("").join(" ")})}(i).toLowerCase():i.toLowerCase()};var t=/\s/,e=/(_|-|\.|:)/,r=/([a-z][A-Z]|[A-Z][a-z])/;var n=/[\W_]+(.|$)/g;var o=/(.)([A-Z]+)/g;return D}var q,J=C(function(){if($)return L;$=1;var t=function(){if(R)return I;R=1;var t=B();return I=function(e){return t(e).replace(/[\W_]+(.|$)/g,function(t,e){return e?" "+e:""}).trim()}}();return L=function(e){return t(e).replace(/\s(\w)/g,function(t,e){return e.toUpperCase()})}}()),U={};var F=function(){if(q)return U;q=1,Object.defineProperty(U,"__esModule",{value:!0}),U.fullJoin=U.leftJoin=U.join=void 0;const t=(t,e)=>{const r=new Map;for(const n of t){const t=e(n);if(r.has(t)){const e=r.get(t);e.push(n),r.set(t,e)}else r.set(t,[n])}return r},e=(e,r,n,o,i,s,u)=>{const c=t(e,n);if(!u&&0===c.size)return[];const l=t(r,o);if(!s&&0===l.size)return[];const a=[];for(const t of c.keys())if(l.has(t)){const e=c.get(t),r=l.get(t);e.forEach(t=>r.forEach(e=>a.push(i(t,e))))}else if(s){c.get(t).forEach(t=>a.push(i(t,void 0)))}if(u)for(const t of l.keys())if(!c.has(t)){l.get(t).forEach(t=>a.push(i(void 0,t)))}return a};return U.join=(t,r,n,o,i)=>e(t,r,n,o,(t,e)=>i(t,e),!1,!1),U.leftJoin=(t,r,n,o,i)=>e(t,r,n,o,(t,e)=>i(t,e),!0,!1),U.fullJoin=(t,r,n,o,i)=>e(t,r,n,o,(t,e)=>i(t,e),!0,!0),U}();function W(t){return Array.isArray(t)?t:[t]}function k(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),r.push.apply(r,n)}return r}function x(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{};e%2?k(Object(r),!0).forEach(function(e){o(t,e,r[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):k(Object(r)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))})}return t}const M="fullJoin",_="DESC",H="IN",z="=",G=".",Y=" as ",Z="id",V="data",K=t=>J(t.replace(/\s/,"_")),Q=t=>"leftJoin"===t?F.leftJoin:t===M?F.fullJoin:F.join,X=(t,e)=>{const r=x(x({},t),e);return t&&t[Z]?x(x({},r),{},{[Z]:t[Z]}):r},tt=(t,e)=>x(x({},t),e),et=(t,e,r,n,o,i)=>t(e,r,t=>t[n],t=>t[o],i);function rt(t,e,r,n={},o){var i,s;const u=function(t,e,r,n){const o={};for(let i=0;i<t.length;i++){const s=t[i],u=ct(e,i),[c]=u;o[s]=c?ut(r,s,c,n,u):void 0}return o}(e,t,r,null==n?void 0:n.joinCond),c=null!=n&&n.join?function(t,e){const[r]=t.join,n=K(r),o=t.joinCond,i=Object.values(e),[s,u,...c]=i,[l,a]=o[0],f=Q(n);let p=et(f,W(s),W(u),l,a,X);for(let e=0;e<c.length;e++){const r=e+1,n=K(t.join[r]),[i,s]=o[r],u=Q(n),l=n===M?tt:X;p=et(u,p,c[e],i,s,l)}return p}(n,u):u,l=[(null==n||null===(i=n.groupBy)||void 0===i?void 0:i.length)>0?t=>function(t,e,r){return t.join?function(t,e){if(!Array.isArray(t))return t;const r=e.map(t=>t.includes(G)?t.split(G)[1]:t);return st(t,r)}(e,t.groupBy):function(t,e,r){const n={};for(let o=0;o<e.length;o++){const i=e[o],s=t[i];if(!Array.isArray(s)){n[i]=s;continue}const u=lt(r,i).map(t=>t.includes(Y)?t.split(Y)[0]:t);n[i]=st(s,u)}return n}(e,r,t.groupBy)}(n,t,e):null,!(null==n||!n.having)&&(t=>function(t,e,r,n){const o=function(t){if(!t)return;const e=t.match(/^(.*?)\s+IN\s*\(([^)]*)\)\s*$/i);if(e){const t=e[1].trim(),r=e[2].trim(),n=r.split(",").map(t=>it(t.trim()));return{field:t,operator:H,values:n}}const r=t.indexOf(z);if(-1!==r){const e=t.slice(0,r).trim(),n=t.slice(r+1).trim();return{field:e,operator:z,value:it(n)}}return}(r);if(!o)return t;if(n)return function(t,e){if(!Array.isArray(t))return t;const r=e.field.includes(G)?e.field.split(G)[1]:e.field;return t.filter(t=>ot(null==t?void 0:t[r],e))}(t,o);{const r=o.field.includes(G)?o.field.split(G)[0]:null,n=o.field.includes(G)?o.field.split(G)[1]:o.field;return e.reduce((e,i)=>{const s=t[i];return Array.isArray(s)?(e[i]=r&&r!==i?s:s.filter(t=>ot(null==t?void 0:t[n],o)),e):(e[i]=s,e)},{})}}(t,e,n.having,Boolean(n.join))),(null==n||null===(s=n.orderBy)||void 0===s?void 0:s.length)>0&&(t=>function(t,e,r,n){return n?function(t,e){if(!Array.isArray(t))return t;const r=e.map(t=>({key:t.field.includes(G)?t.field.split(G)[1]:t.field,dir:t.direction}));return nt(t.slice(),r)}(t,r):e.reduce((e,n)=>{const o=t[n];if(!Array.isArray(o))return e[n]=o,e;const i=function(t,e){return t.reduce((t,r)=>{if(r.field.includes(G)){const[n,o]=r.field.split(G);n===e&&t.push({key:o,dir:r.direction})}else t.push({key:r.field,dir:r.direction});return t},[])}(r,n);return e[n]=i.length>0?nt(o.slice(),i):o,e},{})}(t,e,n.orderBy,Boolean(n.join))),o].filter(Boolean);return l.reduce((t,e)=>e(t),c)}function nt(t,e){return e&&0!==e.length?t.sort((t,r)=>{for(let n=0;n<e.length;n++){const{key:o,dir:i}=e[n],s=null==t?void 0:t[o],u=null==r?void 0:r[o];if(null!=s||null!=u){if(null==s)return 1;if(null==u)return-1;if(s<u)return i===_?1:-1;if(s>u)return i===_?-1:1}}return 0}):t}function ot(t,e){return e.operator===H?e.values.some(e=>e===t):String(t)===String(e.value)}function it(t){if(!t)return t;if(t.startsWith("'")&&t.endsWith("'")||t.startsWith('"')&&t.endsWith('"'))return t.slice(1,-1);return"null"===t.toLowerCase()?null:isNaN(t)||""===t.trim()?t:Number(t)}function st(t,e){if(!e||0===e.length)return t;const r=new Map;for(let n=0;n<t.length;n++){const o=t[n],i=e.map(t=>String(null==o?void 0:o[t])).join("|#|");r.has(i)||r.set(i,o)}return Array.from(r.values())}function ut(t,e,r,n,o){const i=lt(t,e);let s=function(...t){return 1===t.length?t[0]:t.reduce((t,e)=>{const r=new Set(e);return[...new Set(t)].filter(t=>r.has(t))})}(i.map(t=>t.includes(Y)?t.split(Y)[0]:t),Object.keys(r));if(n){const t=Array.from(new Set(n.flat()));s=s.concat(t)}return i.includes("*")?o:function(t,e,r){const n=function(t){return t.reduce((t,e)=>{if(e.includes(Y)){const[r,n]=e.split(Y);t[r]=n}return t},{})}(e),o=[];for(let e=0;e<r.length;e++){const i=r[e],s={};for(let e=0;e<t.length;e++){const r=t[e],o=n[r]||r;Object.prototype.hasOwnProperty.call(i,r)&&(s[o]=i[r])}o.push(s)}return o}(s,i,o)}function ct(t,e){return Array.isArray(t[e][V])?t[e][V]:[t[e][V]]}function lt(t,e){return t.reduce((t,r)=>{const[n,o]=r.split(G);return t.push(n===e?o:r),t},[])}const at=(...t)=>e=>t.reduceRight((t,e)=>e(t),e);const ft={[t.select]:async function(t,e,r={}){const{queryParser:n,resultSetFilter:o}=r,{fields:i,entities:s,conditions:u}=n(P(t));return rt(await Promise.all(s.map(t=>{const r=function(t={},e){const r=c.getNestedRoute(e,t);return r||(t.value?`${e}/${t.value}`:e)}(u,t);return y.get(r,e)})),s,i,u,o)},[t.insert]:async function(t,e){const r={},{entity:n,queryData:o}=function(t,e){let r,n;if(t)r=e.replace(/INSERT INTO/i,"").trim(),n=t;else{const t=S(e);r=t.entity,n=t.data}return{entity:r,queryData:n}}(e,t),i=await y.post(n,o);return r[n]?r[n].push(i.data):r[n]=[i.data],r},[t.update]:async function(t,e){const r={},{entity:n,queryData:o,id:i}=function(t,e){let r,n,o;if(t){const[,i,s]=e.split(/UPDATE\b|\bWHERE\b/i);o=s.split("=")[1].trim(),r=i.trim(),n=t}else{const t=A(e);r=t.entity,n=t.data,o=t.id}return{entity:r,queryData:n,id:o}}(e,t),s=await y.put(`${n}/${i}`,o);return r[n]=s.data,r},[t.delete]:async function(t){const{entity:e,id:r}=function(t){const e=new RegExp([/^s*DELETEs+FROMs+(\w+)/,/s+WHEREs+(.*)$/].map(t=>t.source.replace(/s/g,"\\s")).join(""),"i"),r=t.match(e);if(!r)throw new Error("Invalid or unsupported DELETE query format");return{entity:r[1],id:r[2].split("=")[1].trim()}}(t);return await y.delete(`${e}/${r}`),{id:r}}};async function pt(r,n){const[o]=function(t){return t.replace(e,"").split(" ")}(r),i=t[o.toLowerCase()],s=function(){let t=t=>t,e=t=>t;if(c.hasAddons()){const{queryParsers:r,resultSetFilters:n}=c.getAddons().reduce((t,{queryParser:e,resultSetFilter:r})=>(t.queryParsers.push(e),t.resultSetFilters.push(r),t),{queryParsers:[],resultSetFilters:[]});t=at(...r),e=at(...n)}return{queryParser:t,resultSetFilter:e}}();return ft[i](r,n,s)}export{pt as exec,u as setConfig};
